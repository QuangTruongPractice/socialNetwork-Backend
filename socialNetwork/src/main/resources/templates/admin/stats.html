<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thống kê</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar {
      height: 100vh;
      background-color: #343a40;
      color: white;
    }
    .sidebar a {
      color: white;
      padding: 12px 20px;
      display: block;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #495057;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div th:replace="admin/home :: sidebar"></div>

    <div class="col px-4">
      <h2 class="my-4">Thống kê hệ thống</h2>

      <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
          <select name="type" id="type" class="form-select" onchange="toggleDateFields()">
            <option value="default" th:selected="${selectedType == 'default'}">Theo tất cả năm</option>
            <option value="year" th:selected="${selectedType == 'year'}">Theo năm</option>
            <option value="quarter" th:selected="${selectedType == 'quarter'}">Theo quý</option>
            <option value="month" th:selected="${selectedType == 'month'}">Theo tháng</option>
          </select>
        </div>
        <div class="col-md-2" id="yearField" style="display:none;">
          <select name="year" class="form-select">
            <option th:each="y : ${#numbers.sequence(2022, 2025)}"
                    th:value="${y}" th:text="${y}"
                    th:selected="${selectedYear == y}"></option>
          </select>
        </div>
        <div class="col-md-2" id="quarterField" style="display:none;">
          <select name="quarter" class="form-select">
            <option value="">Chọn quý</option>
            <option th:each="q : ${#numbers.sequence(1, 4)}"
                    th:value="${q}" th:text="'Quý ' + ${q}"
                    th:selected="${selectedQuarter == q}"></option>
          </select>
        </div>
        <div class="col-md-2" id="monthField" style="display:none;">
          <select name="month" class="form-select">
            <option value="">Chọn tháng</option>
            <option th:each="m : ${#numbers.sequence(1, 12)}"
                    th:value="${m}" th:text="'Tháng ' + ${m}"
                    th:selected="${selectedMonth == m}"></option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">Xem</button>
        </div>
      </form>

      <div class="row g-4 mb-4">
          
        <div class="col-md-5">
          <div class="card">
            <div class="card-header bg-primary text-white">Người dùng</div>
            <div class="card-body p-2">
              <table class="table table-sm">
                <thead><tr><th>STT</th><th>Thời gian</th><th>Số lượng</th></tr></thead>
                <tbody>
                <tr th:each="stat, i : ${userStats}">
                  <td th:text="${i.index + 1}"></td>
                  <td th:text="${stat[0]}"></td>
                  <td th:text="${stat[1]}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(userStats)}">
                  <td colspan="3" class="text-center text-muted">Không có dữ liệu</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-7">
          <div class="card">
            <div class="card-header bg-primary text-white">Biểu đồ người dùng</div>
            <div class="card-body"><canvas id="userChart" height="200"></canvas></div>
          </div>
        </div>
      </div>

      <div class="row g-4">
          
        <div class="col-md-5">
          <div class="card">
            <div class="card-header bg-success text-white">Bài viết</div>
            <div class="card-body p-2">
              <table class="table table-sm">
                <thead><tr><th>STT</th><th>Thời gian</th><th>Số lượng</th></tr></thead>
                <tbody>
                <tr th:each="stat, i : ${postStats}">
                  <td th:text="${i.index + 1}"></td>
                  <td th:text="${stat[0]}"></td>
                  <td th:text="${stat[1]}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(postStats)}">
                  <td colspan="3" class="text-center text-muted">Không có dữ liệu</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-7">
          <div class="card">
            <div class="card-header bg-success text-white">Biểu đồ bài viết</div>
            <div class="card-body"><canvas id="postChart" height="200"></canvas></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script th:inline="javascript">
  function toggleDateFields() {
    const type = document.getElementById('type').value;
    document.getElementById('yearField').style.display = type === 'year' ? 'block' : 'none';
    document.getElementById('quarterField').style.display = type === 'quarter' ? 'block' : 'none';
    document.getElementById('monthField').style.display = type === 'month' ? 'block' : 'none';
  }

  document.addEventListener("DOMContentLoaded", function () {
    toggleDateFields();

    const userStats = /*[[${userStats}]]*/ [];
    if (userStats.length) {
      const ctx = document.getElementById('userChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: userStats.map(s => s[0]),
          datasets: [{
            label: 'Người dùng',
            data: userStats.map(s => s[1]),
            backgroundColor: 'rgba(54,162,235,0.6)',
            borderColor: 'rgba(54,162,235,1)',
            borderWidth: 1
          }]
        }
      });
    }

    const postStats = /*[[${postStats}]]*/ [];
    if (postStats.length) {
      const ctx = document.getElementById('postChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: postStats.map(s => s[0]),
          datasets: [{
            label: 'Bài viết',
            data: postStats.map(s => s[1]),
            backgroundColor: 'rgba(40,167,69,0.5)',
            borderColor: 'rgba(40,167,69,1)',
            borderWidth: 1
          }]
        }
      });
    }
  });
</script>
</body>
</html>

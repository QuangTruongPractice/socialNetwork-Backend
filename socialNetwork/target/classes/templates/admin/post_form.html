<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Thêm / Cập nhật bài viết</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <style>
            .sidebar {
                height: 100vh;
                background-color: #343a40;
                color: white;
            }
            .sidebar a {
                color: white;
                text-decoration: none;
                display: block;
                padding: 12px 20px;
                transition: 0.3s;
            }
            .sidebar a:hover {
                background-color: #495057;
            }
            .dynamic-section {
                border: 1px solid #dee2e6;
                border-radius: 0.375rem;
                padding: 1rem;
                margin-top: 1rem;
                background-color: #f8f9fa;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div th:replace="~{admin/home :: sidebar}"></div>
                <div class="col-md-10 p-4">
                    <h2 class="mb-4" th:text="${post.id == null ? 'Thêm bài viết' : 'Cập nhật bài viết'}"></h2>

                    <form th:action="@{/admin/posts/add}" method="post" enctype="multipart/form-data" class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label">Loại bài viết</label>
                            <select name="postType" id="postTypeSelect" class="form-select" required>
                                <option value="">-- Chọn loại bài viết --</option>
                                <option value="POST">Bài viết thường</option>
                                <option value="SURVEY">Khảo sát</option>
                                <option value="INVITATION">Thư mời</option>
                            </select>
                        </div>

                        <div class="col-md-6" th:if="${post.id == null}">
                            <label class="form-label">Người tạo</label>
                            <select name="userId" id="userSelect" class="form-select" required>
                                <option value="">-- Chọn người tạo --</option>
                                <option th:each="u : ${users}" th:value="${u.id}"
                                        th:text="${u.lastName + ' ' + u.firstName + ' - ' + u.userCode}"></option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Nội dung</label>
                            <textarea name="content" class="form-control" rows="4" placeholder="Nhập nội dung bài viết..." required></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Hình ảnh (tuỳ chọn)</label>
                            <input type="file" name="image" class="form-control" accept="image/*" />
                        </div>

                        <div id="surveySection" class="col-12 dynamic-section" style="display: none;">
                            <h5 class="mb-3">Các lựa chọn khảo sát</h5>
                            <div id="surveyOptions">
                                <div class="row mb-2 option-row">
                                    <div class="col-10">
                                        <input type="text" name="surveyOptions" class="form-control" placeholder="Lựa chọn 1" />
                                    </div>
                                    <div class="col-2">
                                        <button type="button" class="btn btn-danger remove-option" disabled>Xóa</button>
                                    </div>
                                </div>
                                <div class="row mb-2 option-row">
                                    <div class="col-10">
                                        <input type="text" name="surveyOptions" class="form-control" placeholder="Lựa chọn 2" />
                                    </div>
                                    <div class="col-2">
                                        <button type="button" class="btn btn-danger remove-option" disabled>Xóa</button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="addOption" class="btn btn-secondary mt-2">Thêm lựa chọn</button>
                        </div>

                        <div id="invitationSection" class="col-12 dynamic-section" style="display: none;">
                            <h5 class="mb-3">Đối tượng nhận thư mời</h5>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="recipients" value="ALL" id="sendToAll">
                                <label class="form-check-label fw-bold text-primary" for="sendToAll">
                                    Gửi cho tất cả mọi người
                                </label>
                            </div>

                            <div class="mb-3">
                                <h6>Chọn nhóm:</h6>
                                <div th:each="group : ${groups}" class="form-check">
                                    <input class="form-check-input recipient-checkbox" type="checkbox" 
                                           name="recipients" th:value="'group:' + ${group.id}" 
                                           th:id="'group_' + ${group.id}">
                                    <label class="form-check-label" th:for="'group_' + ${group.id}" 
                                           th:text="${group.name}"></label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <h6>Chọn tài khoản cụ thể:</h6>
                                <div th:each="account : ${accounts}" class="form-check">
                                    <input class="form-check-input recipient-checkbox" type="checkbox" 
                                           name="recipients" th:value="'account:' + ${account.id}" 
                                           th:id="'account_' + ${account.id}">
                                    <label class="form-check-label" th:for="'account_' + ${account.id}" 
                                           th:text="${account.email + ' (' + account.role + ')'}"></label>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-success">Lưu</button>
                            <a th:href="@{/admin/posts}" class="btn btn-secondary">Quay lại</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const postTypeSelect = document.getElementById('postTypeSelect');
                const surveySection = document.getElementById('surveySection');
                const invitationSection = document.getElementById('invitationSection');
                const addOptionBtn = document.getElementById('addOption');
                const sendToAllCheckbox = document.getElementById('sendToAll');
                const recipientCheckboxes = document.querySelectorAll('.recipient-checkbox');
                const userSelect = document.getElementById('userSelect');
                const currentUserId = '[[${currentUser?.id}]]';

                postTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    surveySection.style.display = selectedType === 'SURVEY' ? 'block' : 'none';
                    invitationSection.style.display = selectedType === 'INVITATION' ? 'block' : 'none';
                    
                    if (userSelect && currentUserId) {
                        if (selectedType === 'SURVEY' || selectedType === 'INVITATION') {
                            userSelect.value = currentUserId;
                            userSelect.disabled = true;
                        } else {
                            userSelect.disabled = false;
                        }
                    }
                });

                addOptionBtn.addEventListener('click', function() {
                    const optionsContainer = document.getElementById('surveyOptions');
                    const optionCount = optionsContainer.children.length;
                    
                    const newOptionDiv = document.createElement('div');
                    newOptionDiv.className = 'row mb-2 option-row';
                    newOptionDiv.innerHTML = `
                        <div class="col-10">
                            <input type="text" name="surveyOptions" class="form-control" placeholder="Lựa chọn ${optionCount + 1}" />
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-danger remove-option">Xóa</button>
                        </div>
                    `;
                    
                    optionsContainer.appendChild(newOptionDiv);
                    updateRemoveButtons();
                });

                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-option')) {
                        e.target.closest('.option-row').remove();
                        updateRemoveButtons();
                        updateOptionPlaceholders();
                    }
                });

                sendToAllCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        recipientCheckboxes.forEach(cb => {
                            cb.checked = false;
                            cb.disabled = true;
                        });
                    } else {
                        recipientCheckboxes.forEach(cb => {
                            cb.disabled = false;
                        });
                    }
                });

                recipientCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            sendToAllCheckbox.checked = false;
                        }
                    });
                });

                function updateRemoveButtons() {
                    const optionRows = document.querySelectorAll('.option-row');
                    optionRows.forEach(row => {
                        const removeBtn = row.querySelector('.remove-option');
                        removeBtn.disabled = optionRows.length <= 2;
                    });
                }

                function updateOptionPlaceholders() {
                    const optionInputs = document.querySelectorAll('#surveyOptions input[name="surveyOptions"]');
                    optionInputs.forEach((input, index) => {
                        input.placeholder = `Lựa chọn ${index + 1}`;
                    });
                }

                updateRemoveButtons();
            });
        </script>
    </body>
</html>